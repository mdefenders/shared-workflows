name: Staging Branch CI

on:
  workflow_call:

jobs:
  call-metrics-init:
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Init Metrics Workflow
    uses: mdefenders/shared-workflows/.github/workflows/metrics-init.yaml@v3

  call-code-quality:
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Code Quality Workflow
    uses: mdefenders/shared-workflows/.github/workflows/code-quality.yaml@v3

  call-build-docker:
    needs: call-code-quality
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Build Docker Workflow
    uses: mdefenders/shared-workflows/.github/workflows/build-docker.yaml@v3
    with:
      push-image: true
    secrets: inherit

  call-scan-docker:
    needs: call-build-docker
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Scan Docker Workflow
    uses: mdefenders/shared-workflows/.github/workflows/scan-docker.yaml@v3
    with:
      new-tag: ${{ needs.call-build-docker.outputs.new-tag }}
    secrets: inherit

  call-cd-deploy:
    needs: call-build-docker
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Deploy Image Workflow
    uses: mdefenders/shared-workflows/.github/workflows/cd-deploy.yaml@v3
    with:
      new-tag: ${{ needs.call-build-docker.outputs.new-tag }}
      gitops-file: ${{ vars.GITOPS_FILE_PATH || 'deploy/environments' }}/staging/${{ vars.GITOPS_FILE_NAME || 'values.yaml' }}
      environment: 'staging'
      replicas: ${{ fromJSON(vars.STAGING_TEST_REPLICAS || '3') }}

  call-trigger-tests:
    needs: call-cd-deploy
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Trigger Post-Deploy Tests Workflow
    uses: mdefenders/shared-workflows/.github/workflows/trigger-tests.yaml@v3
    with:
      new-tag: ${{ needs.call-cd-deploy.outputs.new-tag }}
      current-tag: ${{ needs.call-build-docker.outputs.new-tag }}
      environment: 'staging'
    secrets: inherit

  call-cd-undeploy:
    needs: [call-cd-deploy, call-trigger-tests]
    if: always() && startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Deploy Image Workflow
    uses: mdefenders/shared-workflows/.github/workflows/cd-deploy.yaml@v3
    with:
      new-tag: ${{ needs.call-trigger-tests.outputs.new-tag }}
      gitops-file: ${{ vars.GITOPS_FILE_PATH || 'deploy/environments' }}/staging/${{ vars.GITOPS_FILE_NAME || 'values.yaml' }}
      environment: 'staging'
      replicas: ${{ fromJSON(vars.STAGING_REPLICAS || '0') }}

  call-metrics-push-success:
    needs: [ call-build-docker, call-scan-docker, call-cd-deploy, call-cd-undeploy, call-trigger-tests, call-code-quality, call-metrics-init ]
    if: startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Push Metrics Workflow
    uses: mdefenders/shared-workflows/.github/workflows/metrics-push.yaml@v3
    with:
      start-time: ${{ needs.call-metrics-init.outputs.start-time }}
      workflow-name: 'Staging Branch CI'
      workflow-success: 1
    secrets: inherit

  call-metrics-push-failure:
    needs: [ call-build-docker, call-scan-docker, call-cd-deploy, call-cd-undeploy, call-trigger-tests, call-code-quality, call-metrics-init ]
    if: failure() && startsWith(github.head_ref || github.ref_name, 'main') && github.ref_type == 'branch'
    name: Call Push Metrics Workflow
    uses: mdefenders/shared-workflows/.github/workflows/metrics-push.yaml@v3
    with:
      start-time: ${{ needs.call-metrics-init.outputs.start-time }}
      workflow-name: 'Staging Branch CI'
    secrets: inherit