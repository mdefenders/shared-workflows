name: Develop Branch CI

on:
  workflow_call:

jobs:
  call-code-quality:
    if: startsWith(github.head_ref || github.ref_name, 'develop')
    name: Call Code Quality Workflow
    uses: mdefenders/shared-workflows/.github/workflows/modules/code-quality.yaml@dev

  call-build-docker:
    needs: call-code-quality
    if: startsWith(github.head_ref || github.ref_name, 'develop')
    name: Call Build Docker Workflow
    uses: mdefenders/shared-workflows/.github/workflows/modules/build-docker.yaml@dev
    with:
      push-image: ${{ fromJSON(vars.PUSH_DEV_IMAGE || 'true') }}
    secrets: inherit

  call-scan-docker:
    needs: call-build-docker
    if: startsWith(github.head_ref || github.ref_name, 'develop')
    name: Call Scan Docker Workflow
    uses: mdefenders/shared-workflows/.github/workflows/modules/scan-docker.yaml@dev
    with:
      link-tag: ${{ needs.call-build-docker.outputs.link-tag }}
    secrets: inherit

  call-cd-deploy:
    needs: call-build-docker
    if: startsWith(github.head_ref || github.ref_name, 'develop')
    name: Call Deploy Image Workflow
    uses: mdefenders/shared-workflows/.github/workflows/modules/cd-deploy.yaml@dev
    with:
      link-tag: ${{ needs.call-build-docker.outputs.link-tag }}
      gitops-file: ${{ vars.GITOPS_FILE_PATH || 'deploy/environments' }}/dev/${{ vars.GITOPS_FILE_NAME || 'values.yaml' }}
      environment: 'dev'

  call-trigger-tests:
    needs: call-build-docker
    if: startsWith(github.head_ref || github.ref_name, 'develop')
    name: Call Trigger Post-Deploy Tests Workflow
    uses: mdefenders/shared-workflows/.github/workflows/modules/trigger-tests.yaml@dev
    with:
      link-tag: ${{ needs.call-build-docker.outputs.link-tag }}
      environment: 'dev'